{% extends "base.html" %}

{% block title %}User Settings{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2><i class="bi bi-gear"></i> User Settings</h2>
            <p class="text-muted">Manage your account settings and bot configurations.</p>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-person"></i> Account Information</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-3">Username:</dt>
                        <dd class="col-sm-9">{{ user.username }}</dd>
                        
                        <dt class="col-sm-3">Email:</dt>
                        <dd class="col-sm-9">{{ user.email }}</dd>
                        
                        <dt class="col-sm-3">Admin:</dt>
                        <dd class="col-sm-9">
                            {% if user.is_admin %}
                                <span class="badge bg-success">Yes</span>
                            {% else %}
                                <span class="badge bg-secondary">No</span>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-3">Created:</dt>
                        <dd class="col-sm-9">{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else 'Unknown' }}</dd>
                    </dl>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-robot"></i> Bot Status</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('user_settings.bot_settings') }}" class="btn btn-primary">
                            <i class="bi bi-gear"></i> Configure Bots
                        </a>
                        <button class="btn btn-info" onclick="checkBotStatus()">
                            <i class="bi bi-info-circle"></i> Check Status
                        </button>
                    </div>
                    
                    <div id="bot-status" class="mt-3">
                        <!-- Bot status will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Admin Feedback Management -->
    {% if user.is_admin %}
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-chat-dots"></i> Feedback Management</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Manage user feedback and suggestions.</p>
                    
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h4 id="totalFeedback">-</h4>
                                    <p class="mb-0">Total Feedback</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-dark">
                                <div class="card-body text-center">
                                    <h4 id="pendingFeedback">-</h4>
                                    <p class="mb-0">Pending Review</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4 id="recentFeedback">-</h4>
                                    <p class="mb-0">This Week</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h4 id="implementedFeedback">-</h4>
                                    <p class="mb-0">Implemented</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('feedback.admin_feedback') }}" class="btn btn-primary">
                            <i class="bi bi-chat-dots me-1"></i> Manage All Feedback
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
</div>

<script>
function checkBotStatus() {
    fetch('/settings/api/bot-status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const status = data.status;
                const statusHtml = `
                    <div class="row">
                        <div class="col-6">
                            <strong>Discord:</strong>
                            <span class="badge ${status.discord_running ? 'bg-success' : 'bg-danger'}">
                                ${status.discord_running ? 'Running' : 'Stopped'}
                            </span>
                        </div>
                        <div class="col-6">
                            <strong>Telegram:</strong>
                            <span class="badge ${status.telegram_running ? 'bg-success' : 'bg-danger'}">
                                ${status.telegram_running ? 'Running' : 'Stopped'}
                            </span>
                        </div>
                    </div>
                `;
                document.getElementById('bot-status').innerHTML = statusHtml;
            } else {
                document.getElementById('bot-status').innerHTML = 
                    '<div class="alert alert-danger">Failed to get bot status</div>';
            }
        })
        .catch(error => {
            document.getElementById('bot-status').innerHTML = 
                '<div class="alert alert-danger">Error checking bot status</div>';
        });
}

// Check status on page load
document.addEventListener('DOMContentLoaded', function() {
    checkBotStatus();
    {% if user.is_admin %}
    loadFeedbackStats();
    {% endif %}
});

{% if user.is_admin %}
function loadFeedbackStats() {
    fetch('/settings/api/feedback-stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('totalFeedback').textContent = data.stats.total_feedback;
                document.getElementById('pendingFeedback').textContent = data.stats.pending_feedback;
                document.getElementById('recentFeedback').textContent = data.stats.recent_feedback;
                document.getElementById('implementedFeedback').textContent = data.stats.implemented_feedback;
            }
        })
        .catch(error => {
            console.error('Error loading feedback stats:', error);
        });
}
{% endif %}
</script>
{% endblock %}