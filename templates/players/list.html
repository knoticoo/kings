{% extends "base.html" %}

{% block title %}{{ _("Players") }} - {{ _("King's Choice Management") }}{% endblock %}

{% block content %}
<div class="row">
    <!-- Page Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2 text-primary">
                <i class="bi bi-people-fill me-2"></i>{{ _("Player Management") }}
            </h1>
            <div class="btn-group">
                <a href="{{ url_for('players.add_player') }}" class="btn btn-primary">
                    <i class="bi bi-person-plus me-1"></i>{{ _("Add Player") }}
                </a>
                <a href="{{ url_for('players.assign_mvp') }}" class="btn btn-success">
                    <i class="bi bi-award me-1"></i>{{ _("Assign MVP") }}
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Error Display -->
{% if error %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            {{ error }}
        </div>
    </div>
</div>
{% endif %}

<!-- MVP Rotation Status -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-arrow-repeat me-2"></i>{{ _("MVP Rotation Status") }}
                </h5>
            </div>
            <div class="card-body">
                {% if can_assign_mvp %}
                    <div class="alert alert-success d-flex align-items-center mb-0">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <div>
                            <strong>{{ _("MVP Assignment Available") }}</strong><br>
                            <small>{{ _("Eligible Players") }}: 
                                {% for player in eligible_players %}
                                    <span class="badge bg-primary me-1">{{ player.name }}</span>
                                {% endfor %}
                            </small>
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-warning d-flex align-items-center mb-0">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <div>
                            <strong>{{ _("MVP Assignment Not Available") }}</strong><br>
                            <small>{{ _("No eligible players or events.") }}</small>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Players List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list me-2"></i>{{ _("All Players") }}
                </h5>
            </div>
            <div class="card-body">
                {% if players %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>{{ _("Player") }}</th>
                                    <th>{{ _("Status") }}</th>
                                    <th>{{ _("MVP Count") }}</th>
                                    <th>{{ _("Rotation") }}</th>
                                    <th>{{ _("Created") }}</th>
                                    <th>{{ _("Actions") }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for player in players %}
                                <tr {% if player.is_current_mvp %}class="table-warning"{% elif player.is_excluded %}class="table-secondary"{% endif %}>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if player.is_current_mvp %}
                                                <i class="bi bi-trophy-fill text-warning me-2" title="{{ _('Current MVP') }}"></i>
                                            {% elif player.is_excluded %}
                                                <i class="bi bi-pause-circle-fill text-muted me-2" title="{{ _('Excluded from rotation') }}"></i>
                                            {% else %}
                                                <i class="bi bi-person-circle text-muted me-2"></i>
                                            {% endif %}
                                            <strong>
                                                <a href="#" class="text-decoration-none player-name-link" 
                                                   data-player-id="{{ player.id }}" 
                                                   data-player-name="{{ player.name }}"
                                                   title="{{ _('Show MVP History') }}">
                                                    {{ player.name }}
                                                </a>
                                            </strong>
                                        </div>
                                    </td>
                                    <td>
                                        {% if player.is_current_mvp %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="bi bi-award me-1"></i>{{ _("Current MVP") }}
                                            </span>
                                        {% elif player.mvp_count > 0 %}
                                            <span class="badge bg-success">
                                                <i class="bi bi-check-circle me-1"></i>{{ _("Previous MVP") }}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">
                                                <i class="bi bi-dash-circle me-1"></i>{{ _("Never MVP") }}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{ player.mvp_count }}</span>
                                    </td>
                                    <td>
                                        {% if player.is_excluded %}
                                            <span class="badge bg-secondary">
                                                <i class="bi bi-pause me-1"></i>{{ _("Excluded") }}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-success">
                                                <i class="bi bi-play me-1"></i>{{ _("Active") }}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ player.created_at.strftime('%Y-%m-%d') if player.created_at }}
                                        </small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('players.edit_player', player_id=player.id) }}" 
                                               class="btn btn-outline-primary" title="{{ _('Edit Player') }}">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            {% if player.is_current_mvp %}
                                                <button type="button" class="btn btn-outline-danger" 
                                                        title="{{ _('Unassign MVP') }}"
                                                        onclick="confirmUnassignMVP('{{ player.name }}', {{ player.mvp_assignment_id }})">
                                                    <i class="bi bi-x-circle"></i>
                                                </button>
                                            {% elif player.is_excluded %}
                                                <button type="button" class="btn btn-outline-success" 
                                                        title="{{ _('Include in MVP Rotation') }}"
                                                        onclick="toggleExclusion('{{ player.name }}', {{ player.id }}, false)">
                                                    <i class="bi bi-play"></i>
                                                </button>
                                            {% else %}
                                                <button type="button" class="btn btn-outline-warning" 
                                                        title="{{ _('Exclude from MVP Rotation') }}"
                                                        onclick="toggleExclusion('{{ player.name }}', {{ player.id }}, true)">
                                                    <i class="bi bi-pause"></i>
                                                </button>
                                            {% endif %}
                                            <button type="button" class="btn btn-outline-danger" 
                                                    title="{{ _('Delete Player') }}"
                                                    onclick="confirmDelete('{{ player.name }}', {{ player.id }})">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Players Summary -->
                    <div class="row mt-4">
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="text-primary">{{ players|length }}</h5>
                                    <small class="text-muted">{{ _("Total Players") }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="text-warning">
                                        {{ players|selectattr('is_current_mvp', 'equalto', true)|list|length }}
                                    </h5>
                                    <small class="text-muted">{{ _("Current MVP") }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="text-success">
                                        {{ players|selectattr('mvp_count', 'greaterthan', 0)|list|length }}
                                    </h5>
                                    <small class="text-muted">{{ _("Previous MVPs") }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="text-info">
                                        {{ players|sum(attribute='mvp_count') }}
                                    </h5>
                                    <small class="text-muted">{{ _("Total MVP Awards") }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Stats Row -->
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="text-success">
                                        {{ players|selectattr('is_excluded', 'equalto', false)|list|length }}
                                    </h5>
                                    <small class="text-muted">{{ _("Active Players") }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="text-secondary">
                                        {{ players|selectattr('is_excluded', 'equalto', true)|list|length }}
                                    </h5>
                                    <small class="text-muted">{{ _("Excluded Players") }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="text-primary">
                                        {{ eligible_players|length if eligible_players else 0 }}
                                    </h5>
                                    <small class="text-muted">{{ _("Eligible for MVP") }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-people" style="font-size: 4rem;"></i>
                        <h4 class="mt-3">{{ _("No Players Yet") }}</h4>
                        <p>{{ _("Players have not been added to the system yet.") }}</p>
                        <a href="{{ url_for('players.add_player') }}" class="btn btn-primary">
                            <i class="bi bi-person-plus me-1"></i>{{ _("Add First Player") }}
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _("Confirm Deletion") }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>{{ _("Are you sure you want to delete player") }} <strong id="playerName"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    {{ _("This will also delete all MVP assignments for this player and cannot be undone.") }}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("Cancel") }}</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>{{ _("Delete Player") }}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Exclusion Toggle Confirmation Modal -->
<div class="modal fade" id="exclusionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exclusionModalTitle">{{ _("Confirm Change") }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="exclusionModalText"></p>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <span id="exclusionModalInfo"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("Cancel") }}</button>
                <form id="exclusionForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn" id="exclusionSubmitBtn">
                        <i class="bi me-1" id="exclusionSubmitIcon"></i>
                        <span id="exclusionSubmitText"></span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MVP History Modal -->
<div class="modal fade" id="mvpHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-trophy me-2"></i>{{ _("MVP History") }}: <span id="historyPlayerName"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="historyLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _("Loading...") }}</span>
                    </div>
                    <p class="mt-2">{{ _("Loading MVP history...") }}</p>
                </div>
                
                <div id="historyContent" style="display: none;">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="text-primary mb-0" id="totalMvpCount">0</h4>
                                    <small class="text-muted">{{ _("Total MVP Awards") }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="text-success mb-0" id="totalEvents">0</h4>
                                    <small class="text-muted">{{ _("Event Participations") }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h6 class="mb-3">
                        <i class="bi bi-list-ul me-2"></i>{{ _("Detailed History") }}
                    </h6>
                    
                    <div id="historyList">
                        <!-- History items will be populated here -->
                    </div>
                    
                    <div id="noHistory" class="text-center text-muted py-4" style="display: none;">
                        <i class="bi bi-trophy" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">{{ _("No MVP History Yet") }}</h5>
                        <p>{{ _("This player has not received MVP awards yet.") }}</p>
                    </div>
                </div>
                
                <div id="historyError" class="alert alert-danger" style="display: none;">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span id="historyErrorMessage"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("Close") }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.player-name-link {
    color: inherit !important;
    transition: color 0.2s ease;
}

.player-name-link:hover {
    color: #0d6efd !important;
    text-decoration: underline !important;
}

.player-name-link:focus {
    color: #0d6efd !important;
    text-decoration: underline !important;
    outline: none;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function confirmDelete(playerName, playerId) {
    document.getElementById('playerName').textContent = playerName;
    document.getElementById('deleteForm').action = `/players/delete/${playerId}`;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

function confirmUnassignMVP(playerName, assignmentId) {
    if (confirm(`{{ _("Are you sure you want to unassign MVP for") }} ${playerName}?`)) {
        // Create a form and submit it
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/players/unassign-mvp/${assignmentId}`;
        
        // Add CSRF token if available
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}

function toggleExclusion(playerName, playerId, toExclude) {
    const modalTitle = document.getElementById('exclusionModalTitle');
    const modalText = document.getElementById('exclusionModalText');
    const modalInfo = document.getElementById('exclusionModalInfo');
    const submitBtn = document.getElementById('exclusionSubmitBtn');
    const submitIcon = document.getElementById('exclusionSubmitIcon');
    const submitText = document.getElementById('exclusionSubmitText');
    const form = document.getElementById('exclusionForm');
    
    if (toExclude) {
        modalTitle.textContent = '{{ _("Exclude from MVP Rotation") }}';
        modalText.innerHTML = `{{ _("Are you sure you want to exclude player") }} <strong>${playerName}</strong> {{ _("from MVP rotation?") }}`;
        modalInfo.textContent = '{{ _("Player will remain visible in the list but will not participate in MVP rotation until re-enabled.") }}';
        submitBtn.className = 'btn btn-warning';
        submitIcon.className = 'bi bi-pause me-1';
        submitText.textContent = '{{ _("Exclude") }}';
    } else {
        modalTitle.textContent = '{{ _("Include in MVP Rotation") }}';
        modalText.innerHTML = `{{ _("Are you sure you want to include player") }} <strong>${playerName}</strong> {{ _("in MVP rotation?") }}`;
        modalInfo.textContent = '{{ _("Player will become available for MVP assignment according to rotation logic.") }}';
        submitBtn.className = 'btn btn-success';
        submitIcon.className = 'bi bi-play me-1';
        submitText.textContent = '{{ _("Include") }}';
    }
    
    form.action = `/players/toggle-exclusion/${playerId}`;
    
    const modal = new bootstrap.Modal(document.getElementById('exclusionModal'));
    modal.show();
}

// Auto-refresh rotation status every 30 seconds
setInterval(function() {
    // You can add AJAX call here to refresh rotation status
    console.log('Checking rotation status...');
}, 30000);

// MVP History Modal functionality
document.addEventListener('DOMContentLoaded', function() {
    // Add click event listeners to player name links
    document.querySelectorAll('.player-name-link').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const playerId = this.getAttribute('data-player-id');
            const playerName = this.getAttribute('data-player-name');
            showMvpHistory(playerId, playerName);
        });
    });
});

function showMvpHistory(playerId, playerName) {
    // Set player name in modal title
    document.getElementById('historyPlayerName').textContent = playerName;
    
    // Show loading state
    document.getElementById('historyLoading').style.display = 'block';
    document.getElementById('historyContent').style.display = 'none';
    document.getElementById('historyError').style.display = 'none';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('mvpHistoryModal'));
    modal.show();
    
    // Fetch MVP history
    fetch(`/players/api/mvp-history/${playerId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('historyLoading').style.display = 'none';
            
            if (data.success) {
                displayMvpHistory(data);
            } else {
                showHistoryError(data.error || '{{ _("Failed to load MVP history") }}');
            }
        })
        .catch(error => {
            document.getElementById('historyLoading').style.display = 'none';
            showHistoryError('{{ _("Error loading MVP history") }}: ' + error.message);
        });
}

function displayMvpHistory(data) {
    const historyContent = document.getElementById('historyContent');
    const historyList = document.getElementById('historyList');
    const noHistory = document.getElementById('noHistory');
    
    // Update summary stats
    document.getElementById('totalMvpCount').textContent = data.mvp_count;
    document.getElementById('totalEvents').textContent = data.history.length;
    
    if (data.history.length === 0) {
        historyContent.style.display = 'block';
        noHistory.style.display = 'block';
        historyList.innerHTML = '';
    } else {
        historyContent.style.display = 'block';
        noHistory.style.display = 'none';
        
        // Generate history list
        let historyHtml = '';
        data.history.forEach(function(item, index) {
            const eventDate = item.event_date ? new Date(item.event_date).toLocaleDateString() : '{{ _("Date not specified") }}';
            const assignedDate = item.assigned_at ? new Date(item.assigned_at).toLocaleDateString() : '{{ _("Date not specified") }}';
            
            historyHtml += `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-1 text-center">
                                <span class="badge bg-primary rounded-pill">${index + 1}</span>
                            </div>
                            <div class="col-md-7">
                                <h6 class="mb-1">
                                    <i class="bi bi-trophy-fill text-warning me-2"></i>
                                    ${item.event_name}
                                </h6>
                                ${item.event_description ? `<p class="text-muted mb-0 small">${item.event_description}</p>` : ''}
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="text-muted small">
                                    <div><strong>{{ _("Event") }}:</strong> ${eventDate}</div>
                                    <div><strong>{{ _("Assigned") }}:</strong> ${assignedDate}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        historyList.innerHTML = historyHtml;
    }
}

function showHistoryError(message) {
    document.getElementById('historyErrorMessage').textContent = message;
    document.getElementById('historyError').style.display = 'block';
}
</script>
{% endblock %}