{% extends "base.html" %}

{% block title %}{{ _("Control Panel") }} - {{ _("King's Choice Management") }}{% endblock %}

{% block content %}
<div class="row">
    <!-- Page Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2 text-primary">
                <i class="bi bi-speedometer2 me-2"></i>{{ _("Control Panel") }}
            </h1>
            <div class="text-muted">
                <i class="bi bi-clock me-1"></i>
                <span id="current-time"></span>
            </div>
        </div>
    </div>
</div>

<!-- Error Display -->
{% if error %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            {{ error }}
        </div>
    </div>
</div>
{% endif %}

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-primary text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">{{ _("Total Players") }}</h5>
                        <h2 class="mb-0">{{ total_players }}</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-people-fill fs-1"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="{{ url_for('players.list_players') }}" class="text-white text-decoration-none">
                    <small>{{ _("View all players") }} <i class="bi bi-arrow-right"></i></small>
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-success text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">{{ _("Total Alliances") }}</h5>
                        <h2 class="mb-0">{{ total_alliances }}</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-shield-fill fs-1"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="{{ url_for('alliances.list_alliances') }}" class="text-white text-decoration-none">
                    <small>{{ _("View all alliances") }} <i class="bi bi-arrow-right"></i></small>
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-info text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">{{ _("Total Events") }}</h5>
                        <h2 class="mb-0">{{ total_events }}</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-calendar-event-fill fs-1"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="{{ url_for('events.list_events') }}" class="text-white text-decoration-none">
                    <small>{{ _("View all events") }} <i class="bi bi-arrow-right"></i></small>
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-warning text-dark h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">{{ _("Blacklist") }}</h5>
                        <h2 class="mb-0">{{ total_blacklist_entries }}</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-shield-exclamation fs-1"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="{{ url_for('blacklist.list_blacklist') }}" class="text-dark text-decoration-none">
                    <small>{{ _("View blacklist") }} <i class="bi bi-arrow-right"></i></small>
                </a>
            </div>
        </div>
    </div>
</div>


<!-- Current Status -->
<div class="row mb-4">
    <!-- Current MVP -->
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-award-fill me-2"></i>{{ _("Current MVP") }}
                    </h5>
                    <button type="button" class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#mvpExportModal">
                        <i class="bi bi-download me-1"></i>
                        {{ _("Export") }}
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if current_mvp %}
                    <div class="text-center">
                        <div class="mb-3">
                            <i class="bi bi-trophy-fill text-warning" style="font-size: 3rem;"></i>
                        </div>
                        <h4 class="text-primary">{{ current_mvp.name }}</h4>
                        <p class="text-muted mb-1">{{ _("MVP Count") }}: {{ current_mvp.mvp_count }}</p>
                        <small class="text-muted">
                            <i class="bi bi-clock me-1"></i>
                            {{ _("Last Update") }}: {{ current_mvp.updated_at.strftime('%Y-%m-%d %H:%M') if current_mvp.updated_at }}
                        </small>
                    </div>
                {% else %}
                    <div class="text-center text-muted">
                        <i class="bi bi-question-circle" style="font-size: 3rem;"></i>
                        <h5 class="mt-2">{{ _("MVP not assigned") }}</h5>
                        <p>{{ _("No player currently has MVP status.") }}</p>
                        <a href="{{ url_for('players.assign_mvp') }}" class="btn btn-primary btn-sm">
                            <i class="bi bi-award me-1"></i>{{ _("Assign MVP") }}
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Current Winner -->
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-trophy-fill me-2"></i>{{ _("Current Winner") }}
                </h5>
            </div>
            <div class="card-body">
                {% if current_winner %}
                    <div class="text-center">
                        <div class="mb-3">
                            <i class="bi bi-shield-fill-check text-success" style="font-size: 3rem;"></i>
                        </div>
                        <h4 class="text-success">{{ current_winner.name }}</h4>
                        <p class="text-muted mb-1">{{ _("Win Count") }}: {{ current_winner.win_count }}</p>
                        <small class="text-muted">
                            <i class="bi bi-clock me-1"></i>
                            {{ _("Last Update") }}: {{ current_winner.updated_at.strftime('%Y-%m-%d %H:%M') if current_winner.updated_at }}
                        </small>
                    </div>
                {% else %}
                    <div class="text-center text-muted">
                        <i class="bi bi-question-circle" style="font-size: 3rem;"></i>
                        <h5 class="mt-2">{{ _("Winner not assigned") }}</h5>
                        <p>{{ _("No alliance currently has winner status.") }}</p>
                        <a href="{{ url_for('alliances.assign_winner') }}" class="btn btn-success btn-sm">
                            <i class="bi bi-trophy me-1"></i>{{ _("Assign Winner") }}
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Events -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history me-2"></i>{{ _("Recent Events") }}
                    </h5>
                    <a href="{{ url_for('events.list_events') }}" class="btn btn-outline-primary btn-sm">
                        {{ _("View all events") }}
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if recent_events %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>{{ _("Event") }}</th>
                                    <th>{{ _("Date") }}</th>
                                    <th>MVP</th>
                                    <th>{{ _("Winner") }}</th>
                                    <th>{{ _("Status") }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for event in recent_events[:5] %}
                                <tr>
                                    <td>
                                        <strong>{{ event.name }}</strong>
                                        {% if event.description %}
                                            <br><small class="text-muted">{{ event.description[:50] }}{% if event.description|length > 50 %}...{% endif %}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ event.event_date.strftime('%Y-%m-%d %H:%M') if event.event_date }}</small>
                                    </td>
                                    <td>
                                        {% if event.has_mvp %}
                                            {% if event.mvp_players %}
                                                <div class="d-flex flex-wrap gap-1">
                                                    {% for mvp_name in event.mvp_players %}
                                                        <span class="badge bg-primary">
                                                            <i class="bi bi-award-fill me-1"></i>{{ mvp_name }}
                                                        </span>
                                                    {% endfor %}
                                                    {% if event.mvp_count > 1 %}
                                                        <span class="badge bg-info">
                                                            <i class="bi bi-plus me-1"></i>{{ event.mvp_count }}x
                                                        </span>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <span class="badge bg-primary">
                                                    <i class="bi bi-award-fill me-1"></i>{{ _("Assigned") }}
                                                </span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary">
                                                <i class="bi bi-dash-circle me-1"></i>{{ _("Waiting") }}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if event.has_winner %}
                                            <span class="badge bg-success">
                                                <i class="bi bi-trophy-fill me-1"></i>{{ _("Assigned") }}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">
                                                <i class="bi bi-dash-circle me-1"></i>{{ _("Waiting") }}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if event.has_mvp and event.has_winner %}
                                            <span class="badge bg-success">{{ _("Completed") }}</span>
                                        {% elif event.has_mvp or event.has_winner %}
                                            <span class="badge bg-warning">{{ _("Partial") }}</span>
                                        {% else %}
                                            <span class="badge bg-danger">{{ _("Incomplete") }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-calendar-x" style="font-size: 3rem;"></i>
                        <h5 class="mt-2">{{ _("No events yet") }}</h5>
                        <p>{{ _("Events have not been created yet.") }}</p>
                        <a href="{{ url_for('events.add_event') }}" class="btn btn-primary">
                            <i class="bi bi-calendar-plus me-1"></i>{{ _("Create first event") }}
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- MVP Export Modal -->
<div class="modal fade" id="mvpExportModal" tabindex="-1" aria-labelledby="mvpExportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mvpExportModalLabel">
                    <i class="bi bi-download me-2"></i>
                    {{ _("Export MVP List") }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="mvpExportFormat" class="form-label">{{ _("Export Format") }}</label>
                    <select class="form-select" id="mvpExportFormat">
                        <option value="formatted">{{ _("Formatted Text") }}</option>
                        <option value="simple">{{ _("Simple List") }}</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="mvpExportText" class="form-label">{{ _("Export Text") }}</label>
                    <textarea class="form-control" id="mvpExportText" rows="15" readonly></textarea>
                </div>
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" onclick="copyMvpToClipboard()">
                        <i class="bi bi-clipboard me-1"></i>
                        {{ _("Copy to Clipboard") }}
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {{ _("Close") }}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Update current time
function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleString();
    document.getElementById('current-time').textContent = timeString;
}

// Update time immediately and then every second
updateTime();
setInterval(updateTime, 1000);

// Auto-refresh dashboard data every 30 seconds
setInterval(function() {
    // You can add AJAX calls here to refresh data without page reload
    // For now, we'll just update the timestamp
    updateTime();
}, 30000);

// MVP Export functionality
document.addEventListener('DOMContentLoaded', function() {
    const mvpExportModal = document.getElementById('mvpExportModal');
    const mvpExportText = document.getElementById('mvpExportText');
    const mvpExportFormat = document.getElementById('mvpExportFormat');
    
    mvpExportModal.addEventListener('show.bs.modal', function() {
        generateMvpExportText();
    });
    
    mvpExportFormat.addEventListener('change', function() {
        generateMvpExportText();
    });
    
    function generateMvpExportText() {
        const format = mvpExportFormat.value;
        const now = new Date();
        const dateStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
        
        let text = '';
        
        if (format === 'formatted') {
            text = `MVP [ ${dateStr} ]\n\n`;
            {% for event in recent_events %}
            {% if event.has_mvp and event.mvp_players %}
            {% for mvp_name in event.mvp_players %}
            text += `- {{ mvp_name }} [ {{ event.name }} ]\n`;
            {% endfor %}
            {% endif %}
            {% endfor %}
        } else {
            text = `MVP Export - ${dateStr}\n\n`;
            {% for event in recent_events %}
            {% if event.has_mvp and event.mvp_players %}
            {% for mvp_name in event.mvp_players %}
            text += `{{ mvp_name }} [ {{ event.name }} ]\n`;
            {% endfor %}
            {% endif %}
            {% endfor %}
        }
        
        mvpExportText.value = text;
    }
});

function copyMvpToClipboard() {
    const mvpExportText = document.getElementById('mvpExportText');
    mvpExportText.select();
    mvpExportText.setSelectionRange(0, 99999);
    document.execCommand('copy');
    
    // Show success message
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-check me-1"></i>{{ _("Copied!") }}';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-success');
    
    setTimeout(function() {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
    }, 2000);
}
</script>
{% endblock %}